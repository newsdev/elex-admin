{% extends "base.html" %}

{% block content %}
<style>
    tr.sorting-row td {
        background-color: rgb(212, 232, 193);
    }
    td.sort-handler {
        cursor: move;
        font-weight: bold;
        background-color: #efefef;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <h1 style="margin-bottom:40px;">{{ RACEDATE }} {{ race }}</h1>
    </div>
</div>


{% if race.nyt_race_description %}
<div class="row" style="margin:15px 0;">
    <div class="col-md-12">
        <p id="target-nyt_race_description" style="font-size: 24px;">{{ race.nyt_race_description }}</p>
    </div>
</div>
{% endif %}

{% if ap_winner %}
<div class="row" style="margin:15px 0;">
    <div class="col-md-12">
        <p style="font-size: 32px;">The AP has declared <strong style="color: rgb(51, 102, 0);">{{ ap_winner.first }} {{ ap_winner.last }}</strong> the winner.</p>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-12">
        <table class="table races" id="race-{{race.statepostal}}-{{ race.raceid }}">
            <tr>
                <td><strong>Accept AP calls</strong></td><td><input class="race-ap-toggle" data-raceid="{{race.statepostal}}-{{ race.raceid }}" type="checkbox" {% if race.accept_ap_calls %}checked {% endif%}data-toggle="toggle" data-onstyle="success"></td>
            </tr>
            <tr>
                <td><strong>Race name</strong></td><td><input class="form-control nyt_race_name" name="nyt_race_name" data-raceid="{{race.statepostal}}-{{ race.raceid }}" value="{% if race.nyt_race_name %}{{ race.nyt_race_name }}{% else %}{{ race }}{% endif %}"></td>
            </tr>
            <tr>
                <td><strong>Race description</strong></td><td><textarea class="form-control nyt_race_description" name="nyt_race_description" data-raceid="{{race.statepostal}}-{{ race.raceid }}" >{% if race.nyt_race_description %}{{ race.nyt_race_description }}{% else %}{% endif %}</textarea></td>
            </tr>

            <tr>
                <td><strong>Race preview</strong></td><td><textarea class="form-control nyt_race_preview" name="nyt_race_preview" data-raceid="{{race.statepostal}}-{{ race.raceid }}" >{% if race.nyt_race_preview %}{{ race.nyt_race_preview }}{% else %}{% endif %}</textarea></td>
            </tr>

            <tr>
                <td><strong>Delegate allocation</strong></td><td><textarea class="form-control nyt_delegate_allocation" name="nyt_delegate_allocation" data-raceid="{{race.statepostal}}-{{ race.raceid }}">{% if race.nyt_delegate_allocation %}{{ race.nyt_delegate_allocation }}{% else %}{% endif %}</textarea></td>
            </tr>

            <tr>
                <td><strong>Race result description</strong></td><td><textarea class="form-control nyt_race_result_description" name="nyt_race_result_description" data-raceid="{{race.statepostal}}-{{ race.raceid }}" >{% if race.nyt_race_result_description %}{{ race.nyt_race_result_description }}{% else %}{% endif %}</textarea></td>
            </tr>

            <tr>
                <td><strong>Winner</strong></td>
                <td>
                    <select{% if race.accept_ap_calls %} disabled{% endif %} class="form-control nyt_winner" name="nyt_winner" data-raceid="{{race.statepostal}}-{{ race.raceid }}">
                        <option value=""></option>
                        {% for c in candidates %}
                         <option{% if c.nyt_winner %} selected{% endif %} value="{{ c.candidateid }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        </table>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        {% if candidates %}
        <h3>Candidates</h3>
        <table class="table" style="padding-bottom:0px;margin-bottom:0px;">
            <tr>
                <th width="32%">Name</th>
                <th width="42%">Description</th>
                <th width="12%">Display?</th>
                <th width="10%">Delegates</th>
                <th width="4%"></th>
            </tr>
        </table>
        <table class="table candidates" id="candidate-table">
            {% for c in candidates %}
            <tr id="candidate-{{ c.candidateid }}">
                <td width="32%"><input data-candidateid="{{ c.candidateid }}" class="form-control candidate-name" name="nyt_candidate_name" value="{{ c }}"></td>
                <td width="42%"><textarea data-candidateid="{{ c.candidateid }}" class="form-control candidate-description" name="nyt_candidate_description">{% if c.nyt_candidate_description %}{{ c.nyt_candidate_description }}{% endif %}</textarea></td>
                <td width="12%"><input data-candidateid="{{ c.candidateid }}" type="checkbox" class="form-control candidate-important" name="nyt_candidate_important" {% if c.nyt_candidate_important %}checked {% endif %}data-toggle="toggle" data-onstyle="success"></td>
                <td width="10%"><input data-candidateid="{{ c.candidateid }}" class="form-control nyt-delegates" name="nyt_candidate_name" value="{% if c.nyt_delegates %}{{ c.nyt_delegates }}{% else %}{% endif %}"></td>
                <td class="sort-handler" width="4%"></td>
            </tr>
            {% endfor %}
        </table>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script type="text/javascript">
    $(function(){
        var update_race_inputs = function(data, race_id){
            /*
                Update the static text for a race when it is changed.
            */
            var winner = data['accept_ap_calls'] = $('#race-' + race_id + ' input.race-ap-toggle').prop('checked');
            if (winner) {
                $('#race-' + race_id + ' select.nyt_winner').prop('disabled', true);
            } else {
                $('#race-' + race_id + ' select.nyt_winner').prop('disabled', false);
            }
        };

        var submit_race = function(data){
            /*
                Submit the current state of a race in the form.
            */
            var race_id = $(this).attr('data-raceid');

            console.log(race_id);

            var data = {};

            data['accept_ap_calls'] = $('#race-' + race_id + ' input.race-ap-toggle').prop('checked');
            data['nyt_race_description'] = $('#race-' + race_id + ' textarea.nyt_race_description').val()
            data['nyt_race_preview'] = $('#race-' + race_id + ' textarea.nyt_race_preview').val()
            data['nyt_race_result_description'] = $('#race-' + race_id + ' textarea.nyt_race_result_description').val()
            data['nyt_delegate_allocation'] = $('#race-' + race_id + ' textarea.nyt_delegate_allocation').val()
            data['nyt_race_name'] = $('#race-' + race_id + ' input.nyt_race_name').val()
            data['nyt_winner'] = $('#race-' + race_id + ' select.nyt_winner').val()

            console.log(data);

            $.ajax({
                type: "POST",
                url: '/elections/2017/admin/{{ RACEDATE }}/race/' + race_id + '/',
                data: data,
                success: function(response){ update_race_inputs(data,race_id); },
                dataType: 'JSON'
            });
        };

        var submit_candidate = function(data){
            /*
                Submit the current state of a candidate in the form.
            */
            var candidate_id = $(this).attr('data-candidateid');
            var data = {};

            data['nyt_candidate_name'] = $('#candidate-' + candidate_id + ' input.candidate-name').val();
            data['nyt_candidate_description'] = $('#candidate-' + candidate_id + ' textarea.candidate-description').val();
            data['nyt_candidate_important'] = $('#candidate-' + candidate_id + ' input.candidate-important').prop('checked');
            data['nyt_delegates'] = $('#candidate-' + candidate_id + ' input.nyt-delegates').val();

            $.ajax({
                type: "POST",
                url: '/elections/2017/admin/{{ RACEDATE }}/candidate/' + candidate_id + '/',
                data: data,
                success: function(response){ console.log(response); },
                dataType: 'JSON'
            });
        };

        var set_candidate_indexes = function(data) {
            var $table = $('#candidate-table');
            var data = {}
            candidates = [];
            $table.find('tr').each(function(idx, el){
                if ($(el).attr('id')){
                    candidates.push($(el).attr('id').split('candidate-')[1])
                }
            });
            data['candidates'] = candidates.join();
            $.ajax({
                type: "POST",
                url: '/elections/2017/admin/{{ RACEDATE }}/candidateorder/',
                data: data,
                dataType: 'JSON',
                success: function(response){ console.log(response); }
            });
        }

        var confirm_race_call = function() {
            var candidate_id = $(this).val();
            var nyt_candidate_name = $('#candidate-' + candidate_id + ' input.candidate-name').val();
            var confirmation = null;

            if (!nyt_candidate_name && candidate_id === '') {
                // Set no winner.
                confirmation = confirm("Are you sure that you want to set no winner?");
            } else {
                // Set a race winner.
                confirmation = confirm("Are you sure that you want to set " + nyt_candidate_name + " as the winner?");
            }
            if (confirmation === true) {
                // execute submit_race function with original context
                submit_race.bind(this)();
            } else {
                // reload the page so that we don't do anything
                location.reload();
            }
        }

        $('table.races .form-control').on('blur', submit_race);
        $('table.candidates .form-control').on('blur', submit_candidate);
        $('input.candidate-important').on('change', submit_candidate)
        $('select.nyt_winner').on('change', confirm_race_call);
        $('input.race-ap-toggle').on('change', submit_race);

        $('#candidate-table').rowSorter({
            handler: 'td.sort-handler',
            stickFirstRow : true,
            stickLastRow  : false,
            onDrop: function(tbody, row, new_index, old_index)
            {
                set_candidate_indexes();
            }
        });

    });
</script>
{% endblock %}
